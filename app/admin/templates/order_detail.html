{% extends "base.html" %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }} - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö -->
{% if request.query_params.get('success') == 'price_updated' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> –¶–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% elif request.query_params.get('success') == 'status_updated' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-file-alt"></i> –ó–∞–∫–∞–∑ #{{ order.id }}</h1>
            <div>
                <a href="/debug/files/{{ order.id }}" class="btn btn-sm btn-outline-info me-2" target="_blank">
                    <i class="fas fa-bug"></i> –û—Ç–ª–∞–¥–∫–∞ —Ñ–∞–π–ª–æ–≤
                </a>
                <a href="/orders" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</strong></td>
                                <td>{{ order.work_type }}</td>
                            </tr>
                            <tr>
                                <td><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong></td>
                                <td>{{ order.subject }}</td>
                            </tr>
                            <tr>
                                <td><strong>–û–±—ä–µ–º:</strong></td>
                                <td>{{ order.volume }}</td>
                            </tr>
                            <tr>
                                <td><strong>–°—Ä–æ–∫:</strong></td>
                                <td>{{ order.deadline }}</td>
                            </tr>
                            <tr>
                                <td><strong>–°–æ–∑–¥–∞–Ω:</strong></td>
                                <td>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            </tr>
                            <tr>
                                <td><strong>–û–±–Ω–æ–≤–ª–µ–Ω:</strong></td>
                                <td>{{ order.updated_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>–°—Ç–∞—Ç—É—Å –∏ —Ü–µ–Ω–∞</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                                <td>
                                    <span class="badge 
                                        {% if order.status.value == 'new' %}bg-primary
                                        {% elif order.status.value == 'in_progress' %}bg-warning
                                        {% elif order.status.value == 'ready' %}bg-success
                                        {% elif order.status.value == 'waiting_payment' %}bg-info
                                        {% elif order.status.value == 'sent' %}bg-success
                                        {% elif order.status.value == 'cancelled' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ order.status.value.replace('_', ' ').title() }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–¶–µ–Ω–∞:</strong></td>
                                <td>
                                    {% if order.price %}
                                        {{ order.price }} ‚ÇΩ
                                    {% else %}
                                        <span class="text-muted">–Ω–µ —É–∫–∞–∑–∞–Ω–∞</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <hr>
                
                <h6>–¢–µ–º–∞ —Ä–∞–±–æ—Ç—ã</h6>
                <p class="border p-3 bg-light">{{ order.topic }}</p>
                
                {% if order.requirements %}
                <h6>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</h6>
                <p class="border p-3 bg-light">{{ order.requirements }}</p>
                {% endif %}
                
                <!-- üö® –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å –æ—Ç–ª–∞–¥–∫–æ–π -->
                <h6><i class="fas fa-paperclip"></i> –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h6>
                
                <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏) -->
                <div class="alert alert-info small mb-3">
                    <strong>–û—Ç–ª–∞–¥–∫–∞:</strong> 
                    –§–∞–π–ª–æ–≤ –≤ –æ–±—ä–µ–∫—Ç–µ order: {{ order.files|length if order.files else 0 }}
                    {% if order.files %}
                    <br>ID —Ñ–∞–π–ª–æ–≤: {% for file in order.files %}{{ file.id }}{% if not loop.last %}, {% endif %}{% endfor %}
                    {% endif %}
                </div>
                
                {% if order.files and order.files|length > 0 %}
                <div class="list-group mb-3">
                    {% for file in order.files %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-alt me-2 text-primary"></i>
                            <div>
                                <div class="fw-bold">{{ file.filename or '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π —Ñ–∞–π–ª' }}</div>
                                <small class="text-muted">
                                    {% if file.file_size %}
                                        {{ (file.file_size / 1024 / 1024)|round(2) }} MB
                                    {% else %}
                                        –†–∞–∑–º–µ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
                                    {% endif %}
                                    ‚Ä¢ –ó–∞–≥—Ä—É–∂–µ–Ω: {{ file.uploaded_at.strftime('%d.%m.%Y %H:%M') }}
                                    {% if file.file_type %}
                                    ‚Ä¢ –¢–∏–ø: {{ file.file_type.upper() }}
                                    {% endif %}
                                </small>
                                <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ñ–∞–π–ª–∞ -->
                                <div class="small text-warning">
                                    ID: {{ file.id }} | –ü—É—Ç—å: {{ file.file_path }}
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ -->
                            <a href="/files/download/{{ file.id }}" 
                               class="btn btn-sm btn-outline-primary" 
                               title="–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª {{ file.filename }}"
                               download="{{ file.filename }}">
                                <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å
                            </a>
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ª–∞–¥–∫–∏ -->
                            <button type="button" 
                                    class="btn btn-sm btn-outline-info"
                                    onclick="checkFile('{{ file.id }}, {{ file.filename }}')"
                                    title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å —Ñ–∞–π–ª–∞–º–∏ -->
                <div class="mt-3">
                    <button type="button" 
                            class="btn btn-sm btn-outline-secondary"
                            onclick="loadFilesDebug('{{ order.id }}')">
                        <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                    </button>
                    
                    <a href="/orders/{{ order.id }}/files" 
                       class="btn btn-sm btn-outline-info"
                       target="_blank">
                        <i class="fas fa-list"></i> API —Ñ–∞–π–ª–æ–≤
                    </a>
                </div>
                
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> –ö —ç—Ç–æ–º—É –∑–∞–∫–∞–∑—É –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã —Ñ–∞–π–ª—ã
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
                    <div class="mt-2">
                        <button type="button" 
                                class="btn btn-sm btn-outline-primary"
                                onclick="loadFilesDebug('{{ order.id }}')">
                            <i class="fas fa-search"></i> –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –≤ –ë–î
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>–ò–º—è:</strong></td>
                        <td>{{ order.user.full_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Telegram ID:</strong></td>
                        <td><code>{{ order.user.telegram_id }}</code></td>
                    </tr>
                    {% if order.user.username %}
                    <tr>
                        <td><strong>Username:</strong></td>
                        <td>@{{ order.user.username }}</td>
                    </tr>
                    {% endif %}
                    {% if order.user.phone %}
                    <tr>
                        <td><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong></td>
                        <td>{{ order.user.phone }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</strong></td>
                        <td>{{ order.user.created_at.strftime('%d.%m.%Y') }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–º</h5>
            </div>
            <div class="card-body">
                <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
                <form method="post" action="/orders/{{ order.id }}/status" class="mb-3">
                    <label class="form-label">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                    <div class="input-group">
                        <select name="new_status" class="form-select">
                            {% for status in statuses %}
                            <option value="{{ status.value }}" {% if status == order.status %}selected{% endif %}>
                                {{ status.value.replace('_', ' ').title() }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </form>
                
                <!-- üö® –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º -->
                <form method="post" action="/orders/{{ order.id }}/price">
                    <label class="form-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É (‚ÇΩ):</label>
                    <div class="input-group">
                        <input type="number" 
                               name="price" 
                               class="form-control" 
                               step="0.01" 
                               min="0"
                               value="{{ order.price or '' }}" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É"
                               required>
                        <button type="submit" 
                                class="btn btn-success" 
                                title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –∏ —É–≤–µ–¥–æ–º–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞">
                            <i class="fas fa-ruble-sign"></i> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                    <small class="form-text text-muted">
                        –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ü–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —Ü–µ–Ω—É
                    </small>
                </form>
            </div>
        </div>
        
        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <strong>ID –∑–∞–∫–∞–∑–∞:</strong> {{ order.id }}<br>
                    <strong>–§–∞–π–ª–æ–≤:</strong> {{ order.files|length if order.files else 0 }}<br>
                    <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> {{ order.updated_at.strftime('%d.%m.%Y %H:%M') }}
                </small>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
async function checkFile(fileId, filename) {
    try {
        const response = await fetch(`/files/download/${fileId}`, {method: 'HEAD'});
        if (response.ok) {
            alert(`‚úÖ –§–∞–π–ª "${filename}" –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è`);
        } else {
            alert(`‚ùå –§–∞–π–ª "${filename}" –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (${response.status})`);
        }
    } catch (error) {
        alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–∞: ${error.message}`);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–∞—Ö
async function loadFilesDebug(orderId) {
    try {
        const response = await fetch(`/orders/${orderId}/files`);
        const data = await response.json();
        
        let message = `–§–∞–π–ª–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: ${data.files_count}\n\n`;
        
        if (data.files && data.files.length > 0) {
            data.files.forEach((file, index) => {
                message += `${index + 1}. ${file.filename}\n`;
                message += `   ID: ${file.id}\n`;
                message += `   –†–∞–∑–º–µ—Ä: ${file.file_size || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n`;
                message += `   –ù–∞ –¥–∏—Å–∫–µ: ${file.exists_on_disk ? '‚úÖ' : '‚ùå'}\n\n`;
            });
        } else {
            message += '–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';
        }
        
        alert(message);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã
        if (data.files_count > 0) {
            location.reload();
        }
        
    } catch (error) {
        alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–∞—Ö: ${error.message}`);
    }
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ü–µ–Ω—ã
document.querySelector('form[action*="/price"]').addEventListener('submit', function(e) {
    const price = this.querySelector('input[name="price"]').value;
    if (price && !confirm(`–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É ${price} ‚ÇΩ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É?`)) {
        e.preventDefault();
    }
});

// –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤
document.querySelectorAll('a[href*="/files/download/"]').forEach(function(link) {
    link.addEventListener('click', function() {
        const icon = this.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'fas fa-spinner fa-spin';
        
        setTimeout(function() {
            icon.className = originalClass;
        }, 2000);
    });
});
</script>
{% endblock %}