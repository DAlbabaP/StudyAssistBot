{% extends "base.html" %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }} - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö -->
{% if request.query_params.get('success') == 'price_updated' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> –¶–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% elif request.query_params.get('success') == 'status_updated' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-file-alt"></i> –ó–∞–∫–∞–∑ #{{ order.id }}</h1>
            <div>
                <a href="/debug/files/{{ order.id }}" class="btn btn-sm btn-outline-info me-2" target="_blank">
                    <i class="fas fa-bug"></i> –û—Ç–ª–∞–¥–∫–∞ —Ñ–∞–π–ª–æ–≤
                </a>
                <a href="/orders" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</strong></td>
                                <td>{{ order.work_type }}</td>
                            </tr>
                            <tr>
                                <td><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong></td>
                                <td>{{ order.subject }}</td>
                            </tr>
                            <tr>
                                <td><strong>–û–±—ä–µ–º:</strong></td>
                                <td>{{ order.volume }}</td>
                            </tr>
                            <tr>
                                <td><strong>–°—Ä–æ–∫:</strong></td>
                                <td>{{ order.deadline }}</td>
                            </tr>
                            <tr>
                                <td><strong>–°–æ–∑–¥–∞–Ω:</strong></td>
                                <td>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            </tr>
                            <tr>
                                <td><strong>–û–±–Ω–æ–≤–ª–µ–Ω:</strong></td>
                                <td>{{ order.updated_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>–°—Ç–∞—Ç—É—Å –∏ —Ü–µ–Ω–∞</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                                <td>
                                    <span class="badge 
                                        {% if order.status.value == 'new' %}bg-primary
                                        {% elif order.status.value == 'in_progress' %}bg-warning
                                        {% elif order.status.value == 'ready' %}bg-success
                                        {% elif order.status.value == 'waiting_payment' %}bg-info
                                        {% elif order.status.value == 'sent' %}bg-success
                                        {% elif order.status.value == 'cancelled' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ order.status.value.replace('_', ' ').title() }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–¶–µ–Ω–∞:</strong></td>
                                <td>
                                    {% if order.price %}
                                        {{ order.price }} ‚ÇΩ
                                    {% else %}
                                        <span class="text-muted">–Ω–µ —É–∫–∞–∑–∞–Ω–∞</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <hr>
                
                <h6>–¢–µ–º–∞ —Ä–∞–±–æ—Ç—ã</h6>
                <p class="border p-3 bg-light">{{ order.topic }}</p>
                
                {% if order.requirements %}
                <h6>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</h6>
                <p class="border p-3 bg-light">{{ order.requirements }}</p>
                {% endif %}
                
                <!-- üî• –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ -->
                <h6><i class="fas fa-paperclip"></i> –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h6>
                
                {% if order.files and order.files|length > 0 %}
                <div class="alert alert-info small mb-3">
                    <strong>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> 
                    –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {{ order.files|length }}
                    <br>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="refreshFilesList()">
                        <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    </button>
                </div>

                <div class="list-group mb-3">
                    {% for file in order.files %}
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center">
                                    <!-- –ò–∫–æ–Ω–∫–∞ —Ñ–∞–π–ª–∞ -->
                                    {% if file.file_type %}
                                        {% if file.file_type.lower() == 'pdf' %}
                                            <i class="fas fa-file-pdf me-2 text-danger" style="font-size: 1.5em;"></i>
                                        {% elif file.file_type.lower() in ['doc', 'docx'] %}
                                            <i class="fas fa-file-word me-2 text-primary" style="font-size: 1.5em;"></i>
                                        {% elif file.file_type.lower() in ['jpg', 'jpeg', 'png', 'gif'] %}
                                            <i class="fas fa-file-image me-2 text-success" style="font-size: 1.5em;"></i>
                                        {% elif file.file_type.lower() in ['zip', 'rar'] %}
                                            <i class="fas fa-file-archive me-2 text-warning" style="font-size: 1.5em;"></i>
                                        {% else %}
                                            <i class="fas fa-file me-2 text-secondary" style="font-size: 1.5em;"></i>
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-file me-2 text-secondary" style="font-size: 1.5em;"></i>
                                    {% endif %}
                                    
                                    <div>
                                        <!-- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ -->
                                        <div class="fw-bold text-dark">
                                            {{ file.filename or '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π —Ñ–∞–π–ª' }}
                                        </div>
                                        
                                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ -->
                                        <small class="text-muted">
                                            {% if file.file_size %}
                                                üìä {{ (file.file_size / 1024 / 1024)|round(2) }} MB
                                            {% else %}
                                                üìä –†–∞–∑–º–µ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
                                            {% endif %}
                                            
                                            ‚Ä¢ üìÖ {{ file.uploaded_at.strftime('%d.%m.%Y %H:%M') }}
                                            
                                            {% if file.file_type %}
                                                ‚Ä¢ üìù {{ file.file_type.upper() }}
                                            {% endif %}
                                        </small>
                                        
                                        <!-- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ) -->
                                        <div class="small text-warning mt-1">
                                            üîß ID: {{ file.id }} 
                                            {% if file.file_path %}
                                                ‚Ä¢ –ü—É—Ç—å: ...{{ file.file_path.split('/')[-1] if '/' in file.file_path else file.file_path.split('\\')[-1] }}
                                                ‚Ä¢ –°—É—â–µ—Å—Ç–≤—É–µ—Ç: 
                                                <span id="file-exists-{{ file.id }}" class="badge bg-secondary">–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 text-end">
                                <div class="btn-group" role="group">
                                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
                                    <a href="/files/download/{{ file.id }}" 
                                       class="btn btn-success btn-sm"
                                       title="–°–∫–∞—á–∞—Ç—å {{ file.filename }}"
                                       download="{{ file.filename }}"
                                       onclick="trackDownload('{{ file.id }}', '{{ file.filename }}')">
                                        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å
                                    </a>
                                    
                                    <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                                    <button type="button" 
                                            class="btn btn-outline-info btn-sm"
                                            onclick="checkFileStatus('{{ file.id }}', '{{ file.filename }}')"
                                            title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª">
                                        <i class="fas fa-search"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                    </button>
                                    
                                    <!-- –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–Ω–∏ -->
                                    <button type="button" 
                                            class="btn btn-outline-secondary btn-sm"
                                            onclick="copyFileName('{{ file.filename }}')"
                                            title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–º—è —Ñ–∞–π–ª–∞">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">üîß –î–µ–π—Å—Ç–≤–∏—è —Å —Ñ–∞–π–ª–∞–º–∏</h6>
                        <div class="btn-group me-2" role="group">
                            <button type="button" 
                                    class="btn btn-outline-primary btn-sm"
                                    onclick="refreshFilesList()">
                                <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                            </button>
                            
                            <a href="/orders/{{ order.id }}/files" 
                               class="btn btn-outline-info btn-sm"
                               target="_blank">
                                <i class="fas fa-code"></i> API –¥–∞–Ω–Ω—ã–µ
                            </a>
                            
                            <a href="/debug/files/{{ order.id }}" 
                               class="btn btn-outline-warning btn-sm"
                               target="_blank">
                                <i class="fas fa-bug"></i> –ü–æ–ª–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞
                            </a>
                        </div>
                        
                        <button type="button" 
                                class="btn btn-outline-success btn-sm"
                                onclick="checkAllFiles()">
                            <i class="fas fa-check-double"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã
                        </button>
                    </div>
                </div>

                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>–ö —ç—Ç–æ–º—É –∑–∞–∫–∞–∑—É –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã —Ñ–∞–π–ª—ã</strong>
                    
                    <div class="mt-3">
                        <button type="button" 
                                class="btn btn-outline-primary"
                                onclick="searchForFiles()">
                            <i class="fas fa-search"></i> –ü–æ–∏—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã –≤ —Å–∏—Å—Ç–µ–º–µ
                        </button>
                        
                        <a href="/debug/files/{{ order.id }}" 
                           class="btn btn-outline-info"
                           target="_blank">
                            <i class="fas fa-bug"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>–ò–º—è:</strong></td>
                        <td>{{ order.user.full_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Telegram ID:</strong></td>
                        <td><code>{{ order.user.telegram_id }}</code></td>
                    </tr>
                    {% if order.user.username %}
                    <tr>
                        <td><strong>Username:</strong></td>
                        <td>@{{ order.user.username }}</td>
                    </tr>
                    {% endif %}
                    {% if order.user.phone %}
                    <tr>
                        <td><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong></td>
                        <td>{{ order.user.phone }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</strong></td>
                        <td>{{ order.user.created_at.strftime('%d.%m.%Y') }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–º</h5>
            </div>
            <div class="card-body">
                <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
                <form method="post" action="/orders/{{ order.id }}/status" class="mb-3">
                    <label class="form-label">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                    <div class="input-group">
                        <select name="new_status" class="form-select">
                            {% for status in statuses %}
                            <option value="{{ status.value }}" {% if status == order.status %}selected{% endif %}>
                                {{ status.value.replace('_', ' ').title() }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </form>
                
                <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º -->
                <form method="post" action="/orders/{{ order.id }}/price">
                    <label class="form-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É (‚ÇΩ):</label>
                    <div class="input-group">
                        <input type="number" 
                               name="price" 
                               class="form-control" 
                               step="0.01" 
                               min="0"
                               value="{{ order.price or '' }}" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É"
                               required>
                        <button type="submit" 
                                class="btn btn-success" 
                                title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –∏ —É–≤–µ–¥–æ–º–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞">
                            <i class="fas fa-ruble-sign"></i> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                    <small class="form-text text-muted">
                        –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ü–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —Ü–µ–Ω—É
                    </small>
                </form>
            </div>
        </div>
        
        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <strong>ID –∑–∞–∫–∞–∑–∞:</strong> {{ order.id }}<br>
                    <strong>–§–∞–π–ª–æ–≤:</strong> {{ order.files|length if order.files else 0 }}<br>
                    <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> {{ order.updated_at.strftime('%d.%m.%Y %H:%M') }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ -->
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const ORDER_ID = ('{{ order.id }}');
let fileStatusCache = {};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
async function checkFileStatus(fileId, filename) {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ HEAD –∑–∞–ø—Ä–æ—Å
        const response = await fetch(`/files/download/${fileId}`, {
            method: 'HEAD'
        });
        
        const statusBadge = document.getElementById(`file-exists-${fileId}`);
        let message = '';
        
        if (response.ok) {
            message = `‚úÖ –§–∞–π–ª "${filename}" –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è\n`;
            message += `üìä –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}\n`;
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
            const contentLength = response.headers.get('Content-Length');
            const contentType = response.headers.get('Content-Type');
            const contentDisposition = response.headers.get('Content-Disposition');
            
            if (contentLength) {
                const sizeMB = (parseInt(contentLength) / 1024 / 1024).toFixed(2);
                message += `üìè –†–∞–∑–º–µ—Ä: ${sizeMB} MB\n`;
            }
            
            if (contentType) {
                message += `üìù –¢–∏–ø: ${contentType}\n`;
            }
            
            if (contentDisposition) {
                message += `üìã –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${contentDisposition}\n`;
            }
            
            if (statusBadge) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = '–¥–æ—Å—Ç—É–ø–µ–Ω';
            }
            
            fileStatusCache[fileId] = 'available';
        } else {
            message = `‚ùå –§–∞–π–ª "${filename}" –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n`;
            message += `üìä –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`;
            
            if (statusBadge) {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
            }
            
            fileStatusCache[fileId] = 'unavailable';
        }
        

        
    } catch (error) {
        alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–∞ "${filename}":\n${error.message}`);
        
        const statusBadge = document.getElementById(`file-exists-${fileId}`);
        if (statusBadge) {
            statusBadge.className = 'badge bg-warning';
            statusBadge.textContent = '–æ—à–∏–±–∫–∞';
        }
    } finally {
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
async function checkAllFiles() {
    const fileIds = [];
    document.querySelectorAll('[id^="file-exists-"]').forEach(badge => {
        const fileId = badge.id.replace('file-exists-', '');
        fileIds.push(fileId);
    });
    
    if (fileIds.length === 0) {
        alert('–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
        return;
    }
    
    for (const fileId of fileIds) {
        const button = document.querySelector(`button[onclick*="checkFileStatus('${fileId}'"]`);
        if (button) {
            button.click();
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
}

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
function copyFileName(filename) {
    navigator.clipboard.writeText(filename).then(() => {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalHtml;
            button.classList.add('btn-outline-secondary');
            button.classList.remove('btn-success');
        }, 1500);
    }).catch(err => {
        alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err);
    });
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
function trackDownload(fileId, filename) {
    console.log(`üîó –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: ID=${fileId}, –ò–º—è="${filename}"`);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
    const link = event.target.closest('a');
    const icon = link.querySelector('i');
    const originalClass = icon.className;
    
    icon.className = 'fas fa-spinner fa-spin';
    
    setTimeout(() => {
        icon.className = originalClass;
    }, 2000);
    
    return true; // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
async function refreshFilesList() {
    try {
        const response = await fetch(`/orders/${ORDER_ID}/files`);
        const data = await response.json();
        
        let message = `üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ #${ORDER_ID}\n\n`;
        message += `üìä –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${data.files_count}\n\n`;
        
        if (data.files && data.files.length > 0) {
            data.files.forEach((file, index) => {
                message += `${index + 1}. ${file.filename}\n`;
                message += `   üÜî ID: ${file.id}\n`;
                message += `   üìè –†–∞–∑–º–µ—Ä: ${file.file_size ? (file.file_size / 1024 / 1024).toFixed(2) + ' MB' : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n`;
                message += `   üíæ –ù–∞ –¥–∏—Å–∫–µ: ${file.exists_on_disk ? '‚úÖ' : '‚ùå'}\n`;
                message += `   üìÖ –ó–∞–≥—Ä—É–∂–µ–Ω: ${new Date(file.uploaded_at).toLocaleString('ru-RU')}\n\n`;
            });
            
            message += '\nüîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π?';
            
            if (confirm(message)) {
                location.reload();
            }
        } else {
            message += '‚ùå –§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';
            alert(message);
        }
        
    } catch (error) {
        alert(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤:\n${error.message}`);
    }
}

// –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ
async function searchForFiles() {
    try {
        const response = await fetch(`/debug/files/${ORDER_ID}`);
        const data = await response.json();
        
        let message = `üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ #${ORDER_ID}\n\n`;
        message += `üìä –ó–∞–ø–∏—Å–µ–π –≤ –ë–î: ${data.files_count}\n\n`;
        
        if (data.files && data.files.length > 0) {
            data.files.forEach((file, index) => {
                message += `${index + 1}. üìÑ ${file.db_filename}\n`;
                message += `   üÜî ID –≤ –ë–î: ${file.id}\n`;
                message += `   üíæ –§–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ: ${file.disk_filename || '–Ω–µ –Ω–∞–π–¥–µ–Ω'}\n`;
                message += `   üìè –†–∞–∑–º–µ—Ä –≤ –ë–î: ${file.file_size ? (file.file_size / 1024 / 1024).toFixed(2) + ' MB' : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n`;
                message += `   üíø –†–∞–∑–º–µ—Ä –Ω–∞ –¥–∏—Å–∫–µ: ${file.disk_size ? (file.disk_size / 1024 / 1024).toFixed(2) + ' MB' : '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}\n`;
                message += `   ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç: ${file.exists_on_disk ? '–¥–∞' : '–Ω–µ—Ç'}\n`;
                message += `   üéØ –†–∞–∑–º–µ—Ä—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç: ${file.size_match !== null ? (file.size_match ? '–¥–∞' : '–Ω–µ—Ç') : '–Ω/–¥'}\n\n`;
            });
        } else {
            message += '‚ùå –§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∏ –≤ –ë–î, –Ω–∏ –Ω–∞ –¥–∏—Å–∫–µ';
        }
        
        alert(message);
        
    } catch (error) {
        alert(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤:\n${error.message}`);
    }
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–Ω—ã
document.addEventListener('DOMContentLoaded', function() {
    const priceForm = document.querySelector('form[action*="/price"]');
    if (priceForm) {
        priceForm.addEventListener('submit', function(e) {
            const price = this.querySelector('input[name="price"]').value;
            if (price && !confirm(`–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É ${price} ‚ÇΩ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É?`)) {
                e.preventDefault();
            }
        });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(checkAllFiles, 1000);
});
</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤ */
.list-group-item {
    border-left: 4px solid #007bff;
    margin-bottom: 0.5rem;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

.btn-group .btn {
    margin-right: 0;
}

.file-status-available {
    color: #28a745;
    font-weight: bold;
}

.file-status-unavailable {
    color: #dc3545;
    font-weight: bold;
}

.file-status-checking {
    color: #ffc107;
    font-weight: bold;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
.btn:hover {
    transform: translateY(-1px);
    transition: transform 0.2s ease;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
.small.text-warning {
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
}
</style>
{% endblock %}