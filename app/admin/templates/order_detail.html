{% extends "base.html" %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.id }} - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö -->
{% if request.query_params.get('success') == 'price_updated' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> –¶–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% elif request.query_params.get('success') == 'status_updated' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% elif request.query_params.get('success') == 'message_sent' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-paper-plane"></i> –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% elif request.query_params.get('success') == 'file_uploaded' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-cloud-upload-alt"></i> –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% elif request.query_params.get('success') == 'file_sent' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-paper-plane"></i> –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-file-alt"></i> –ó–∞–∫–∞–∑ #{{ order.id }}</h1>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2" onclick="showCommunicationPanel()">
                    <i class="fas fa-comments"></i> –û–±—â–µ–Ω–∏–µ
                </button>
                <a href="/orders" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</strong></td>
                                <td>{{ order.work_type }}</td>
                            </tr>
                            <tr>
                                <td><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong></td>
                                <td>{{ order.subject }}</td>
                            </tr>
                            <tr>
                                <td><strong>–û–±—ä–µ–º:</strong></td>
                                <td>{{ order.volume }}</td>
                            </tr>
                            <tr>
                                <td><strong>–°—Ä–æ–∫:</strong></td>
                                <td>{{ order.deadline }}</td>
                            </tr>
                            <tr>
                                <td><strong>–°–æ–∑–¥–∞–Ω:</strong></td>
                                <td>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            </tr>
                            <tr>
                                <td><strong>–û–±–Ω–æ–≤–ª–µ–Ω:</strong></td>
                                <td>{{ order.updated_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>–°—Ç–∞—Ç—É—Å –∏ —Ü–µ–Ω–∞</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                                <td>
                                    <span class="badge 
                                        {% if order.status.value == 'new' %}bg-primary
                                        {% elif order.status.value == 'in_progress' %}bg-warning
                                        {% elif order.status.value == 'ready' %}bg-success
                                        {% elif order.status.value == 'waiting_payment' %}bg-info
                                        {% elif order.status.value == 'sent' %}bg-success
                                        {% elif order.status.value == 'cancelled' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ order.status.value.replace('_', ' ').title() }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–¶–µ–Ω–∞:</strong></td>
                                <td>
                                    {% if order.price %}
                                        {{ order.price }} ‚ÇΩ
                                    {% else %}
                                        <span class="text-muted">–Ω–µ —É–∫–∞–∑–∞–Ω–∞</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <hr>
                
                <h6>–¢–µ–º–∞ —Ä–∞–±–æ—Ç—ã</h6>
                <p class="border p-3 bg-light">{{ order.topic }}</p>
                
                {% if order.requirements %}
                <h6>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</h6>
                <p class="border p-3 bg-light">{{ order.requirements }}</p>
                {% endif %}
                
                <!-- üÜï –ü–ê–ù–ï–õ–¨ –û–ë–©–ï–ù–ò–Ø -->
                <div id="communicationPanel" class="mt-4" style="display: none;">
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0 d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-comments"></i> –î–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º
                    <span id="unreadBadge" class="badge bg-warning ms-2" style="display: none;">0</span>
                </span>
                <button type="button" class="btn btn-sm btn-outline-light" onclick="hideCommunicationPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </h6>
        </div>
        <div class="card-body">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
            <div class="alert alert-info mb-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-user-circle me-2"></i>
                    <div>
                        <strong>{{ order.user.full_name }}</strong>
                        {% if order.user.username %}(@{{ order.user.username }}){% endif %}
                        <br>
                        <small class="text-muted">
                            Telegram ID: {{ order.user.telegram_id }} ‚Ä¢ 
                            –ó–∞–∫–∞–∑ #{{ order.id }}: {{ order.work_type }}
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- –î–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ -->
            <div class="border rounded mb-3" style="height: 400px; overflow-y: auto; background: #f8f9fa;" id="dialogWindow">
                <div class="p-3">
                    <div id="dialogMessages">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–∞...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <form id="messageForm" method="post" action="/orders/{{ order.id }}/send_message" class="mb-3">
                <div class="input-group">
                    <textarea class="form-control" 
                              id="messageInput" 
                              name="message" 
                              rows="2" 
                              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞..."
                              required></textarea>
                    <button type="submit" class="btn btn-primary" id="sendButton">
                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </form>
            
            <!-- –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã -->
            <div class="mb-3">
                <h6 class="small text-muted mb-2">–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã:</h6>
                <div class="btn-group-sm d-flex flex-wrap gap-1">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sendQuickMessage('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É.')">
                        üìù –ü—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="sendQuickMessage('–í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤! –û–∂–∏–¥–∞–µ–º –æ–ø–ª–∞—Ç—É.')">
                        ‚úÖ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="sendQuickMessage('–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.')">
                        üôè –°–ø–∞—Å–∏–±–æ
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="sendQuickMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –ø–æ –≤–∞—à–µ–º—É –∑–∞–∫–∞–∑—É.')">
                        ‚ùì –£—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏
                    </button>
                </div>
            </div>
            
            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–º -->
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadFullDialog()">
                        <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–ª–æ–≥
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="scrollToBottom()">
                        <i class="fas fa-arrow-down"></i> –í–Ω–∏–∑
                    </button>
                </div>
                <div>
                    <small class="text-muted">
                        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="lastUpdate">-</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
                
                <!-- –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã -->
                <h6><i class="fas fa-paperclip"></i> –§–∞–π–ª—ã –∑–∞–∫–∞–∑–∞</h6>
                
                <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤ -->
                <ul class="nav nav-tabs" id="filesTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="client-files-tab" data-bs-toggle="tab" data-bs-target="#client-files" type="button" role="tab">
                            <i class="fas fa-user"></i> –û—Ç –∫–ª–∏–µ–Ω—Ç–∞ 
                            <span class="badge bg-secondary ms-1">{{ order.client_files_count }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admin-files-tab" data-bs-toggle="tab" data-bs-target="#admin-files" type="button" role="tab">
                            <i class="fas fa-user-shield"></i> –û—Ç –∞–¥–º–∏–Ω–∞ 
                            <span class="badge bg-secondary ms-1">{{ order.admin_files_count }}</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="filesTabsContent">
                    <!-- –§–∞–π–ª—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ -->
                    <div class="tab-pane fade show active" id="client-files" role="tabpanel">
                        <div class="p-3">
                            {% set client_files = order.files | selectattr("uploaded_by_admin", "equalto", False) | list %}
                            {% if client_files %}
                            <div class="list-group">
                                {% for file in client_files %}
                                <div class="list-group-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-file me-2 text-primary"></i>
                                                <div>
                                                    <div class="fw-bold">{{ file.filename }}</div>
                                                    <small class="text-muted">
                                                        {{ (file.file_size / 1024 / 1024)|round(2) }} MB ‚Ä¢ 
                                                        {{ file.uploaded_at.strftime('%d.%m.%Y %H:%M') }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <a href="/files/download/{{ file.id }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-inbox"></i> –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–∏–ª —Ñ–∞–π–ª—ã
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- –§–∞–π–ª—ã –æ—Ç –∞–¥–º–∏–Ω–∞ -->
                    <div class="tab-pane fade" id="admin-files" role="tabpanel">
                        <div class="p-3">
                            <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∞–¥–º–∏–Ω–æ–º -->
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-cloud-upload-alt"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                                    </h6>
                                    <form method="post" action="/orders/{{ order.id }}/upload_file" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <input type="file" class="form-control" name="file" required>
                                            <div class="form-text">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë</div>
                                        </div>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –æ—Ç –∞–¥–º–∏–Ω–∞ -->
                            <div id="adminFilesList">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="loadAdminFiles()">
                                <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>–ò–º—è:</strong></td>
                        <td>{{ order.user.full_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Telegram ID:</strong></td>
                        <td><code>{{ order.user.telegram_id }}</code></td>
                    </tr>
                    {% if order.user.username %}
                    <tr>
                        <td><strong>Username:</strong></td>
                        <td>@{{ order.user.username }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</strong></td>
                        <td>{{ order.user.created_at.strftime('%d.%m.%Y') }}</td>
                    </tr>
                </table>
                
                <!-- üÜï –ë–´–°–¢–†–û–ï –û–ë–©–ï–ù–ò–ï -->
                <div class="mt-3">
                    <h6>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</h6>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="showCommunicationPanel()">
                            <i class="fas fa-comments"></i> –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="sendQuickMessage('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É.')">
                            <i class="fas fa-play"></i> "–ü—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É"
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="sendQuickMessage('–í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤! –û–∂–∏–¥–∞–µ–º –æ–ø–ª–∞—Ç—É.')">
                            <i class="fas fa-check"></i> "–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤"
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–º</h5>
            </div>
            <div class="card-body">
                <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
                <form method="post" action="/orders/{{ order.id }}/status" class="mb-3">
                    <label class="form-label">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                    <div class="input-group">
                        <select name="new_status" class="form-select">
                            {% for status in statuses %}
                            <option value="{{ status.value }}" {% if status == order.status %}selected{% endif %}>
                                {{ status.value.replace('_', ' ').title() }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </form>
                
                <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã -->
                <form method="post" action="/orders/{{ order.id }}/price">
                    <label class="form-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É (‚ÇΩ):</label>
                    <div class="input-group">
                        <input type="number" 
                               name="price" 
                               class="form-control" 
                               step="0.01" 
                               min="0"
                               value="{{ order.price or '' }}" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É"
                               required>
                        <button type="submit" 
                                class="btn btn-success" 
                                title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –∏ —É–≤–µ–¥–æ–º–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞">
                            <i class="fas fa-ruble-sign"></i>
                        </button>
                    </div>
                    <small class="form-text text-muted">
                        –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —Ü–µ–Ω—É
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const ORDER_ID = '{{ order.id }}';

// –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –æ–±—â–µ–Ω–∏—è
function showCommunicationPanel() {
    document.getElementById('communicationPanel').style.display = 'block';
    loadMessageHistory();
}

// –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –æ–±—â–µ–Ω–∏—è
function hideCommunicationPanel() {
    document.getElementById('communicationPanel').style.display = 'none';
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
async function loadMessageHistory() {
    const container = document.getElementById('messageHistory');
    container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    try {
        const response = await fetch(`/orders/${ORDER_ID}/messages`);
        const data = await response.json();
        
        if (data.messages && data.messages.length > 0) {
            let html = '';
            data.messages.forEach(message => {
                const isAdmin = message.from_admin;
                const badgeClass = isAdmin ? 'bg-primary' : 'bg-secondary';
                const iconClass = isAdmin ? 'fa-user-shield' : 'fa-user';
                
                html += `
                    <div class="d-flex mb-2 ${isAdmin ? 'justify-content-end' : ''}">
                        <div class="card ${isAdmin ? 'bg-primary text-white' : 'bg-light'}" style="max-width: 80%;">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas ${iconClass} me-1"></i>
                                    <small class="fw-bold">${message.sender}</small>
                                    <small class="ms-auto opacity-75">
                                        ${new Date(message.sent_at).toLocaleString('ru-RU')}
                                    </small>
                                </div>
                                <div>${message.text}</div>
                                ${message.delivered ? '' : '<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</small>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="text-muted text-center">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
        }
    } catch (error) {
        container.innerHTML = '<div class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    }
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
async function sendQuickMessage(message) {
    if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: "${message}"?`)) return;
    
    try {
        const formData = new FormData();
        formData.append('message', message);
        
        const response = await fetch(`/orders/${ORDER_ID}/send_message`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
            setTimeout(() => loadMessageHistory(), 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –æ—Ç –∞–¥–º–∏–Ω–∞
async function loadAdminFiles() {
    const container = document.getElementById('adminFilesList');
    container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    try {
        const response = await fetch(`/orders/${ORDER_ID}/admin_files`);
        const data = await response.json();
        
        if (data.files && data.files.length > 0) {
            let html = '<div class="list-group">';
            data.files.forEach(file => {
                const sentBadge = file.sent_to_user ? 
                    '<span class="badge bg-success">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>' : 
                    '<span class="badge bg-warning">–ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>';
                
                html += `
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file me-2 text-success"></i>
                                    <div>
                                        <div class="fw-bold">${file.filename}</div>
                                        <small class="text-muted">
                                            ${(file.file_size / 1024 / 1024).toFixed(2)} MB ‚Ä¢ 
                                            ${new Date(file.uploaded_at).toLocaleString('ru-RU')}
                                        </small>
                                        <div>${sentBadge}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group">
                                    <a href="/files/download/${file.id}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    ${!file.sent_to_user ? `
                                    <button type="button" class="btn btn-sm btn-success" onclick="sendFileToUser(${file.id}, '${file.filename}')">
                                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="text-muted text-center">–§–∞–π–ª–æ–≤ –æ—Ç –∞–¥–º–∏–Ω–∞ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
        }
    } catch (error) {
        container.innerHTML = '<div class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</div>';
    }
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
async function sendFileToUser(fileId, filename) {
    if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª "${filename}" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?`)) return;
    
    try {
        const response = await fetch(`/orders/${ORDER_ID}/send_file/${fileId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showNotification('–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!', 'success');
            setTimeout(() => loadAdminFiles(), 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadAdminFiles();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageForm = document.querySelector('form[action*="send_message"]');
    if (messageForm) {
        messageForm.addEventListener('submit', function() {
            setTimeout(() => loadMessageHistory(), 1000);
        });
    }
});
</script>
{% endblock %}

// –°–æ–∑–¥–∞—Ç—å –ø—É–∑—ã—Ä—å —Å–æ–æ–±—â–µ–Ω–∏—è
function createMessageBubble(message) {
    const isAdmin = message.from_admin;
    const bubbleClass = isAdmin ? 'bg-primary text-white ms-auto' : 'bg-light text-dark me-auto';
    const alignClass = isAdmin ? 'justify-content-end' : 'justify-content-start';
    const iconClass = isAdmin ? 'fa-user-shield' : 'fa-user';
    const senderColor = isAdmin ? 'text-white-50' : 'text-muted';
    
    const messageTime = new Date(message.sent_at).toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    return `
        <div class="d-flex ${alignClass} mb-3">
            <div class="card ${bubbleClass}" style="max-width: 75%; min-width: 200px;">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas ${iconClass} me-2"></i>
                        <small class="fw-bold">${message.sender}</small>
                        <small class="ms-auto ${senderColor}">
                            ${messageTime}
                        </small>
                    </div>
                    <div style="white-space: pre-wrap;">${escapeHtml(message.text)}</div>
                    ${!message.delivered && !isAdmin ? 
                        '<small class="text-warning mt-1"><i class="fas fa-exclamation-triangle"></i> –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</small>' : 
                        ''
                    }
                </div>
            </div>
        </div>
    `;
}

// –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥ –≤–Ω–∏–∑
function scrollToBottom() {
    const dialogWindow = document.getElementById('dialogWindow');
    dialogWindow.scrollTop = dialogWindow.scrollHeight;
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async function checkUnreadMessages() {
    try {
        const response = await fetch(`/orders/${ORDER_ID}/unread_count`);
        const data = await response.json();
        
        const badge = document.getElementById('unreadBadge');
        if (data.unread_count > 0) {
            badge.textContent = data.unread_count;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    }
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
async function sendQuickMessage(message) {
    if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å: "${message}"?`)) return;
    
    await sendMessage(message);
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
async function sendMessage(messageText) {
    const sendButton = document.getElementById('sendButton');
    const messageInput = document.getElementById('messageInput');
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    try {
        const formData = new FormData();
        formData.append('message', messageText);
        
        const response = await fetch(`/orders/${ORDER_ID}/send_message`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ —Ä—É—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (messageText === messageInput.value) {
                messageInput.value = '';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
            setTimeout(loadFullDialog, 1000);
            
        } else {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–æ–æ–±—â–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            if (messageInput.value.trim()) {
                sendMessage(messageInput.value.trim());
            }
        });
    }
    
    // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (this.value.trim()) {
                    sendMessage(this.value.trim());
                }
            }
        });
    }
});

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;',
        '\n': '<br>'
    };
    return text.replace(/[&<>"'\n]/g, function(m) { return map[m]; });
}
</script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ */
.card.bg-primary {
    border-left: 4px solid #0056b3;
}

.card.bg-light {
    border-left: 4px solid #6c757d;
}

#dialogWindow {
    background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
}

#dialogWindow::-webkit-scrollbar {
    width: 6px;
}

#dialogWindow::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#dialogWindow::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

#dialogWindow::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
.card {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>